version: 2.1

jobs:
  lint_dockerfiles:
     docker:
       - image: circleci/python:3.9-buster-node-browsers-legacy
     steps:
      - checkout
      - run: 
         name: "Install hadolint from source"
         command: |
            sudo wget -O /bin/hadolint https://github.com/hadolint/hadolint/releases/download/v1.16.3/hadolint-Linux-x86_64
            sudo chmod +x /bin/hadolint
      - run: 
         name: "Lint Dockerfiles"
         command: |
            /bin/hadolint ./Dockerfile
            /bin/hadolint ./db/Dockerfile
      - run:
         name: "On failure"
         command: |
            echo "Linting Dockerfiles has failed"
         when: on_fail
  
  build_and_push_containers:
     docker:
      - image: docker:20.10.22-git
     steps:
       - checkout
       - run: 
          name: "Authenticate with ECR"
          command: |
            echo "Authenticating with ECR"
            aws --version
            


workflows:
  main-workflow:
    jobs:
      - lint_dockerfiles
